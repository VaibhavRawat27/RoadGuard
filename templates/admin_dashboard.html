{% extends 'layout.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}

<div class="card fade-in">

  <!-- Header -->
  <div class="header-section">
    <h2>Admin Dashboard</h2>
    <p class="small-muted">Manage requests and assign tasks to mechanics.</p>
    <div class="header-actions">
      <a href="{{ url_for('admin_download_report') }}" class="btn download-btn">Download Report</a>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="summary-grid mt-16">
    <div class="summary-card">
      <h3>{{ all_requests|length }}</h3>
      <p>Total Requests</p>
    </div>
    <div class="summary-card">
      <h3>{{ mechanics|length }}</h3>
      <p>Total Mechanics</p>
    </div>
    <div class="summary-card">
      <h3>{{ users|length }}</h3>
      <p>Total Users</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid mt-16">
    <div class="chart-card">
      <h4>Requests by Status</h4>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="chart-card">
      <h4>Requests Today</h4>
      <canvas id="todayChart"></canvas>
    </div>
    <div class="chart-card">
      <h4>Requests per Mechanic</h4>
      <canvas id="mechanicChart"></canvas>
    </div>
  </div>

  <!-- Pending / Rejected requests -->
  <h3 class="mt-24">‚è≥ Pending & Rejected Requests</h3>
  {% if pending %}
    <ul class="request-list">
      {% for p in pending %}
      <li class="list-item">
        <div>
          <strong>#{{ p.id }}</strong> ‚Äî {{ p.title }}
          {% if p.status == 'rejected' %}
          <span class="badge rejected">Rejected</span>
          {% else %}
          <span class="badge pending">Pending</span>
          {% endif %}
        </div>
        <form method="post" action="{{ url_for('admin_assign') }}" class="assign-form">
          <input type="hidden" name="req_id" value="{{ p.id }}">
          <select name="mech_id" required>
            <option value="">-- Assign Mechanic --</option>
            {% for m in mechanics %}
              <option value="{{ m.id }}">{{ m.name }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn small">Assign</button>
        </form>
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty">No pending or rejected requests üéâ</div>
  {% endif %}

  <!-- Recent requests -->
  <h3 class="mt-24">üìã Recent Requests</h3>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Status</th>
          <th>User</th>
          <th>Mechanic</th>
        </tr>
      </thead>
      <tbody>
      {% for r in all_requests %}
      <tr>
        <td>#{{ r.id }}</td>
        <td>{{ r.title }}</td>
        <td><span class="badge {{ r.status|lower }}">{{ r.status }}</span></td>
        <td>{{ r.user.name if r.user else "‚Äî" }}</td>
        <td>{{ r.mechanic.name if r.mechanic else "‚Äî" }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ---------- Requests by Status ----------
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  const statusChart = new Chart(statusCtx, {
    type: 'bar',
    data: {
      labels: ['submitted','pending','accepted','rejected','enroute','completed'],
      datasets: [{
        label: '# of Requests',
        data: [
          {{ all_requests|selectattr("status","equalto","submitted")|list|length }},
          {{ all_requests|selectattr("status","equalto","pending")|list|length }},
          {{ all_requests|selectattr("status","equalto","accepted")|list|length }},
          {{ all_requests|selectattr("status","equalto","rejected")|list|length }},
          {{ all_requests|selectattr("status","equalto","enroute")|list|length }},
          {{ all_requests|selectattr("status","equalto","completed")|list|length }}
        ],
        backgroundColor: ['#fbbf24','#facc15','#4ade80','#f87171','#38bdf8','#a3e635'],
        borderWidth: 1
      }]
    },
    options: { responsive: true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,precision:0}} }
  });

  // ---------- Requests Today ----------
  const todayCtx = document.getElementById('todayChart').getContext('2d');
  const todayData = new Array(24).fill(0);
  {% for r in all_requests %}
    {% if r.created_at.date() == datetime.utcnow().date() %}
      todayData[{{ r.created_at.hour }}] += 1;
    {% endif %}
  {% endfor %}
  const todayChart = new Chart(todayCtx, {
    type: 'line',
    data: {
      labels: [...Array(24).keys()].map(h => h + ":00"),
      datasets: [{
        label: 'Requests Today',
        data: todayData,
        fill: true,
        backgroundColor: 'rgba(59, 130, 246, 0.2)',
        borderColor: '#3b82f6',
        tension: 0.3,
        pointRadius: 4
      }]
    },
    options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true,precision:0}} }
  });

  // ---------- Requests per Mechanic ----------
  const mechanicCtx = document.getElementById('mechanicChart').getContext('2d');
  const mechanicLabels = [
    {% for m in mechanics %}'{{ m.name }}',{% endfor %}
  ];
  const mechanicData = [
    {% for m in mechanics %}
      {{ all_requests|selectattr("mechanic","equalto",m)|list|length }},
    {% endfor %}
  ];
  const mechanicChart = new Chart(mechanicCtx, {
    type: 'pie',
    data: {
      labels: mechanicLabels,
      datasets: [{
        label: 'Requests per Mechanic',
        data: mechanicData,
        backgroundColor: [
          '#f87171','#fbbf24','#4ade80','#38bdf8','#a3e635','#f472b6','#60a5fa','#fcd34d','#34d399','#818cf8'
        ]
      }]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom'}} }
  });
</script>

<!-- CSS -->
<style>
.header-section { margin-bottom: 16px; }
.header-section h2 { margin: 0; font-size: 28px; font-weight: 600; }
.header-section .small-muted { color: #666; font-size: 14px; margin-top: 4px; }
.header-actions { display:flex; justify-content:flex-end; margin-top:12px; }
.btn.download-btn { background-color:#3b82f6; color:white; padding:8px 16px; border-radius:8px; text-decoration:none; font-weight:600; transition:0.2s; }
.btn.download-btn:hover { background-color:#2563eb; }

.summary-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:16px; margin-top:16px; }
.summary-card { background:var(--card,#fff); text-align:center; padding:16px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
.summary-card h3 { margin:0; font-size:24px; color:var(--accent,#3b82f6); }
.summary-card p { margin:4px 0 0; color:var(--muted,#666); }

.charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:24px; margin-top:24px; }
.chart-card { background:var(--card,#fff); padding:16px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
.chart-card h4 { margin-bottom:12px; font-size:16px; font-weight:600; }
.chart-card canvas { width:100% !important; height:200px !important; }

.request-list { list-style:none; padding:0; margin:12px 0; display:flex; flex-direction:column; gap:12px; }
.request-list .list-item { background:var(--card,#fff); padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
.assign-form { display:flex; gap:8px; align-items:center; }
.assign-form select { padding:6px; border-radius:6px; margin-right:5px; border:1px solid #cfd9e3; }

.table-wrapper { margin-top:12px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; margin-top:8px; }
table th, table td { padding:8px 12px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.06); }
table th { color:var(--muted,#666); font-weight:600; }

.badge { display:inline-block; padding:2px 8px; border-radius:6px; font-size:12px; font-weight:600; }
.badge.pending { background-color:#facc15; color:#78350f; }
.badge.rejected { background-color:#f87171; color:#7f1d1d; }
.badge.accepted { background-color:#4ade80; color:#166534; }
.badge.enroute { background-color:#38bdf8; color:#0c4a6e; }
.badge.completed { background-color:#a3e635; color:#365314; }

.empty { text-align:center; padding:16px; color:#666; font-style:italic; }
</style>

{% endblock %}
