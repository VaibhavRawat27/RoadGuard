{% extends 'layout.html' %}
{% block title %}User Dashboard{% endblock %}
{% block content %}

<div class="card fade-in">
  <h2>User Dashboard</h2>

  <!-- Main Tabs -->
  <div class="tabs-container mt-16">
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab(event, 'requests')">üìã My Requests</button>
      <button class="tab-btn" onclick="openTab(event, 'new')">‚ûï New Request</button>
      <button class="tab-btn" onclick="openTab(event, 'profile')">üë§ Profile</button>
    </div>
    <div class="tab-underline"></div>
  </div>

  <!-- Tab Content: My Requests -->
  <div id="requests" class="tab-content active mt-16">
    {% if requests %}
      <!-- Status Tabs -->
      <div class="status-tabs mb-4">
        <button class="status-tab active" onclick="setStatusFilter('all')">All ({{ requests|length }})</button>
        <button class="status-tab" onclick="setStatusFilter('submitted')">Pending ({{ requests|selectattr('status','equalto','submitted')|list|length }})</button>
        <button class="status-tab" onclick="setStatusFilter('accepted')">Accepted ({{ requests|selectattr('status','equalto','accepted')|list|length }})</button>
        <button class="status-tab" onclick="setStatusFilter('enroute')">Enroute ({{ requests|selectattr('status','equalto','enroute')|list|length }})</button>
        <button class="status-tab" onclick="setStatusFilter('completed')">Completed ({{ requests|selectattr('status','equalto','completed')|list|length }})</button>
        <button class="status-tab" onclick="setStatusFilter('rejected')">Rejected ({{ requests|selectattr('status','equalto','rejected')|list|length }})</button>
      </div>

      <!-- Search -->
      <div class="mb-4">
        <input type="text" id="searchInput" placeholder="Search requests..." class="search-input" onkeyup="applyFilters()">
      </div>

      <!-- Requests Table -->
      <div class="table-wrapper">
        <table class="request-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Status</th>
              <th>Mechanic</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="requestTableBody">
            {% for r in requests %}
            <tr data-status="{{ r.status|lower }}">
              <td>#{{ r.id }}</td>
              <td>{{ r.title }}</td>
              <td><span class="badge {{ r.status|lower }}">{{ r.status }}</span></td>
              <td>{% if r.mechanic %}{{ r.mechanic.name }}{% else %}-{% endif %}</td>
              <td><a href="{{ url_for('request_detail', req_id=r.id) }}" class="btn small no-underline">View</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty">No requests yet.</div>
    {% endif %}
  </div>

  <!-- Tab Content: Create New Request -->
  <div id="new" class="tab-content mt-16" style="display:none;">
    <form method="post" action="{{ url_for('new_request') }}" enctype="multipart/form-data">
      <div class="mb-8">
        <label for="title">Car info</label>
        <input id="title" name="title" required placeholder="Please specify your car info.">
      </div>
      <div class="mb-8">
        <label for="issue_type">Issue Type</label>
        <select id="issue_type" name="issue_type" required>
          <option value="Flat Tire">Flat Tire</option>
          <option value="Engine Failure">Engine Failure</option>
          <option value="Battery Dead">Battery Dead</option>
          <option value="Accident">Accident</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-8">
        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Describe the issue in detail..."></textarea>
      </div>
      <div class="mb-8">
        <label for="image">Upload Image (optional)</label>
        <input id="image" name="image" type="file" accept="image/*">
      </div>
      <input type="hidden" name="lat" id="lat">
      <input type="hidden" name="lng" id="lng">

      <div class="mb-8">
        <p><strong>Location:</strong></p>
        <button type="button" class="btn small" onclick="getLocation()">üìç Use My Location</button>
        <p id="loc-status" class="small-muted mt-8">Not detected yet. Click to detect.</p>
      </div>
      <p>Or click on the map to set location:</p>
      <div id="map" style="height:300px" class="mb-8"></div>
      <button type="submit" class="btn" style="width:100%;">Submit Request</button>
    </form>
  </div>

  <!-- Tab Content: Profile -->
  <div id="profile" class="tab-content mt-16" style="display:none;">
    <form method="post" action="{{ url_for('update_profile') }}">
      <div class="mb-8">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" value="{{ current_user.name }}">
      </div>
      <div class="mb-8">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" value="{{ current_user.email }}">
      </div>
      <div class="mb-8">
        <label for="phone">Phone</label>
        <input id="phone" name="phone" type="text" value="{{ current_user.phone }}">
      </div>
      <button type="submit" class="btn" style="width:100%;">Update Profile</button>
    </form>
  </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ---------------- Tabs ----------------
function openTab(evt, tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).style.display = 'block';
    evt.currentTarget.classList.add('active');

    const tabsContainer = document.querySelector('.tabs-container .tab-underline');
    const activeBtn = evt.currentTarget;
    tabsContainer.style.width = activeBtn.offsetWidth + 'px';
    tabsContainer.style.left = activeBtn.offsetLeft + 'px';
}

window.addEventListener('load', () => {
    const activeBtn = document.querySelector('.tab-btn.active');
    const tabsContainer = document.querySelector('.tabs-container .tab-underline');
    tabsContainer.style.width = activeBtn.offsetWidth + 'px';
    tabsContainer.style.left = activeBtn.offsetLeft + 'px';
});

// ---------------- Map ----------------
let map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker = L.marker([20.5937, 78.9629], {draggable: true}).addTo(map);

marker.on('dragend', function(e){
    let pos = marker.getLatLng();
    document.getElementById('lat').value = pos.lat;
    document.getElementById('lng').value = pos.lng;
    document.getElementById('loc-status').innerText = `‚úÖ Location set! Lat: ${pos.lat.toFixed(5)}, Lng: ${pos.lng.toFixed(5)}`;
});

function getLocation() {
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position){
            let lat = position.coords.latitude;
            let lng = position.coords.longitude;
            marker.setLatLng([lat, lng]);
            map.setView([lat, lng], 14);
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            document.getElementById('loc-status').innerText = "‚úÖ Location detected!";
        }, function(error){
            alert("Unable to get location: " + error.message);
        });
    } else {
        alert("Geolocation is not supported by your browser.");
    }
}

map.on('click', function(e){
    let lat = e.latlng.lat;
    let lng = e.latlng.lng;
    marker.setLatLng([lat, lng]);
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
    document.getElementById('loc-status').innerText = `‚úÖ Location set! Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
});

// ---------------- Filters ----------------
let currentStatusFilter = 'all';

function setStatusFilter(status) {
    currentStatusFilter = status;
    document.querySelectorAll('.status-tab').forEach(tab => tab.classList.remove('active'));
    event.currentTarget.classList.add('active');
    applyFilters();
}

function applyFilters() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#requestTableBody tr');

    rows.forEach(row => {
        const matchesStatus = currentStatusFilter === 'all' || row.dataset.status === currentStatusFilter;
        const matchesSearch = row.textContent.toLowerCase().includes(searchText);

        row.style.display = (matchesStatus && matchesSearch) ? '' : 'none';
    });
}
</script>

<style>
/* Tabs */
.tabs-container { position: relative; margin-bottom: 16px; }
.tabs { display:flex; gap:8px; border-bottom:1px solid #444; }
.tab-btn { flex:1; padding:12px 0; background:transparent; border:none; cursor:pointer; font-weight:600; color:#aaa; text-align:center; transition:all 0.3s; }
.tab-btn.active { color:#000; }
.tab-btn:hover { color:#000; }
.tab-underline { position:absolute; bottom:0; left:0; height:3px; background:#000; transition: all 0.3s ease; border-radius:2px; }

/* Status Tabs */
.status-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
.status-tab { padding:6px 12px; border:1px solid #333; border-radius:6px; background:transparent; cursor:pointer; font-weight:600; transition: all 0.2s; }
.status-tab.active { background:#333; color:#fff; }
.status-tab:hover { background:#555; color:#fff; }

/* Table */
.table-wrapper { overflow-x:auto; }
.request-table { width:100%; border-collapse: collapse; }
.request-table th, .request-table td { padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); text-align:left; }
.request-table th { background:rgba(255,255,255,0.02); }
.no-underline { text-decoration:none; }

/* Search Input */
.search-input { width:100%; padding:8px; border:2px solid black; border-radius:6px; background:var(--bg-alt); color:var(--text); }
</style>

{% endblock %}
